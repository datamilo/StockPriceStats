<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H001 Enhanced Multi-Period Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        /* Key Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card .subvalue {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Section Headers */
        .section-header {
            background: #f8f9fa;
            padding: 20px;
            margin: 30px 0 20px 0;
            border-left: 5px solid #667eea;
            border-radius: 4px;
        }

        .section-header h2 {
            color: #667eea;
            font-size: 1.8em;
            margin: 0;
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-group select:hover {
            border-color: #667eea;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* Charts Container */
        .chart-container {
            position: relative;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .error-message {
            color: #dc3545;
            padding: 15px;
            background: #f8d7da;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 1.1em;
        }

        /* Statistics Tables */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-table thead {
            background: #667eea;
            color: white;
        }

        .stats-table th, .stats-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .stats-table tbody tr:hover {
            background: #f8f9fa;
        }

        .stats-table .success-high {
            color: #28a745;
            font-weight: bold;
        }

        .stats-table .success-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .stats-table .success-low {
            color: #dc3545;
            font-weight: bold;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            background: white;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 H001 Multi-Period Low Support Analysis</h1>
        <p class="subtitle">Advanced Analysis: Support Levels, Trade Timing, and Option Expiry</p>

        <!-- Key Statistics -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading statistics...</div>
        </div>

        <!-- Stock Price Chart Section -->
        <div class="section-header">
            <h2>📈 Stock Price Chart with Support Levels</h2>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="stockSelect">Stock:</label>
                <select id="stockSelect">
                    <option value="">-- Select Stock --</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="periodSelect">Low Period:</label>
                <select id="periodSelect">
                    <option value="">-- Select Period --</option>
                    <option value="1-Month">1-Month Low</option>
                    <option value="3-Month">3-Month Low</option>
                    <option value="6-Month">6-Month Low</option>
                    <option value="9-Month">9-Month Low</option>
                    <option value="1-Year">1-Year Low</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="waitSelect">Wait Days (After Low):</label>
                <select id="waitSelect">
                    <option value="">-- Select Wait Days --</option>
                </select>
                <div class="filter-info" id="waitInfo"></div>
            </div>

            <div class="filter-group">
                <label for="expirySelect">Option Expiry:</label>
                <select id="expirySelect">
                    <option value="">-- Select Expiry --</option>
                    <option value="7">7 days</option>
                    <option value="14">14 days</option>
                    <option value="21">21 days</option>
                    <option value="30">30 days</option>
                    <option value="45">45 days</option>
                </select>
            </div>
        </div>

        <div class="chart-container">
            <div id="chartMessage" class="loading">Select stock and filters above to view chart</div>
            <div class="chart-wrapper" id="chartWrapper" style="display: none;">
                <canvas id="priceChart"></canvas>
            </div>
            <div id="chartStats" style="display: none; margin-top: 20px;">
                <table class="stats-table">
                    <tr>
                        <td><strong>Total Trades:</strong></td>
                        <td id="totalTrades">-</td>
                        <td><strong>Success Rate:</strong></td>
                        <td id="successRate" class="success-high">-</td>
                    </tr>
                    <tr>
                        <td><strong>Successful:</strong></td>
                        <td id="successCount" style="color: #28a745;">-</td>
                        <td><strong>Failed:</strong></td>
                        <td id="failureCount" style="color: #dc3545;">-</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Period Performance Overview -->
        <div class="section-header">
            <h2>📊 Period Performance Summary</h2>
        </div>

        <div class="grid-2">
            <div>
                <div class="chart-title">Success Rates by Period</div>
                <div class="chart-wrapper">
                    <canvas id="periodSuccessChart"></canvas>
                </div>
            </div>

            <div>
                <div class="chart-title">Trade Volume by Period</div>
                <div class="chart-wrapper">
                    <canvas id="periodVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Period Statistics Table -->
        <div class="chart-container">
            <div class="chart-title">Detailed Statistics by Period</div>
            <table class="stats-table" id="periodStatsTable">
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Total Trades</th>
                        <th>Successful</th>
                        <th>Failed</th>
                        <th>Success Rate</th>
                        <th>Unique Stocks</th>
                        <th>Support Events</th>
                    </tr>
                </thead>
                <tbody id="periodStatsBody">
                </tbody>
            </table>
        </div>

        <!-- Wait Days Analysis -->
        <div class="section-header">
            <h2>⏰ Impact of Wait Days on Success</h2>
        </div>

        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="waitDaysChart"></canvas>
            </div>
        </div>

        <!-- Expiry Days Analysis -->
        <div class="section-header">
            <h2>📅 Impact of Option Expiry on Success</h2>
        </div>

        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="expiryDaysChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let dashboardData = null;
        let priceChartInstance = null;

        // Wait time constraints
        const WAIT_TIME_CONSTRAINTS = {
            '1-Month': [0, 30],
            '3-Month': [0, 30, 60, 90],
            '6-Month': [0, 30, 60, 90, 120, 180],
            '9-Month': [0, 30, 60, 90, 120, 180],
            '1-Year': [0, 30, 60, 90, 120, 180]
        };

        // Embedded dashboard data - generated from enhanced_dashboard_data.json
        const embeddedDashboardData = {"statistics": {"1_month": {"total_trades": 3009145, "successful_trades": 2304812, "failed_trades": 697822, "success_rate": 76.59358389176992, "by_wait_days": {"0": {"success_count": 1278637, "total_count": 1826805, "success_rate": 69.9930753419221}, "30": {"success_count": 1026175, "total_count": 1182340, "success_rate": 86.79187035878005}}, "by_expiry_days": {"7": {"success_count": 524375, "total_count": 601829, "success_rate": 87.13023134478398}, "14": {"success_count": 487604, "total_count": 601829, "success_rate": 81.02035628060462}, "21": {"success_count": 460331, "total_count": 601829, "success_rate": 76.48867036982266}, "30": {"success_count": 433208, "total_count": 601829, "success_rate": 71.98190848230976}, "45": {"success_count": 399294, "total_count": 601829, "success_rate": 66.34675298132858}}, "unique_stocks": 70, "unique_support_dates": 6457}, "3_month": {"total_trades": 5774715, "successful_trades": 5194912, "failed_trades": 540264, "success_rate": 89.95962571313044, "by_wait_days": {"0": {"success_count": 1506810, "total_count": 1805805, "success_rate": 83.442564396488}, "30": {"success_count": 1329555, "total_count": 1449425, "success_rate": 91.72982389568277}, "60": {"success_count": 1219207, "total_count": 1307020, "success_rate": 93.28143410200302}, "90": {"success_count": 1139340, "total_count": 1212465, "success_rate": 93.96889807128453}}, "by_expiry_days": {"7": {"success_count": 1097314, "total_count": 1154943, "success_rate": 95.01022994208373}, "14": {"success_count": 1067288, "total_count": 1154943, "success_rate": 92.41044796150113}, "21": {"success_count": 1042001, "total_count": 1154943, "success_rate": 90.22098926094189}, "30": {"success_count": 1013758, "total_count": 1154943, "success_rate": 87.77558719348055}, "45": {"success_count": 974551, "total_count": 1154943, "success_rate": 84.38087420764488}}, "unique_stocks": 70, "unique_support_dates": 6397}, "6_month": {"total_trades": 8683555, "successful_trades": 8139307, "failed_trades": 436610, "success_rate": 93.73242871151274, "by_wait_days": {"0": {"success_count": 1583490, "total_count": 1774305, "success_rate": 89.2456482960934}, "30": {"success_count": 1457657, "total_count": 1547025, "success_rate": 94.22323491863416}, "60": {"success_count": 1371850, "total_count": 1444080, "success_rate": 94.99819954573154}, "90": {"success_count": 1306766, "total_count": 1371590, "success_rate": 95.27380631238198}, "120": {"success_count": 1251801, "total_count": 1315070, "success_rate": 95.18892530435642}, "180": {"success_count": 1167743, "total_count": 1231485, "success_rate": 94.82397268338632}}, "by_expiry_days": {"7": {"success_count": 1677893, "total_count": 1736711, "success_rate": 96.61325344285837}, "14": {"success_count": 1653357, "total_count": 1736711, "success_rate": 95.20046801108532}, "21": {"success_count": 1631637, "total_count": 1736711, "success_rate": 93.9498281521796}, "30": {"success_count": 1606521, "total_count": 1736711, "success_rate": 92.50364626008587}, "45": {"success_count": 1569899, "total_count": 1736711, "success_rate": 90.39494769135452}}, "unique_stocks": 70, "unique_support_dates": 6307}, "9_month": {"total_trades": 8953960, "successful_trades": 8506409, "failed_trades": 340253, "success_rate": 95.00164173170307, "by_wait_days": {"0": {"success_count": 1598576, "total_count": 1742805, "success_rate": 91.72431798164453}, "30": {"success_count": 1500575, "total_count": 1571175, "success_rate": 95.50654764746129}, "60": {"success_count": 1432849, "total_count": 1491855, "success_rate": 96.04478987569168}, "90": {"success_count": 1380213, "total_count": 1435565, "success_rate": 96.14423589318491}, "120": {"success_count": 1334769, "total_count": 1390920, "success_rate": 95.96303166249676}, "180": {"success_count": 1259427, "total_count": 1321640, "success_rate": 95.29274235041312}}, "by_expiry_days": {"7": {"success_count": 1740685, "total_count": 1790792, "success_rate": 97.20196427055738}, "14": {"success_count": 1721599, "total_count": 1790792, "success_rate": 96.13617885270874}, "21": {"success_count": 1704480, "total_count": 1790792, "success_rate": 95.18023310356534}, "30": {"success_count": 1684443, "total_count": 1790792, "success_rate": 94.06134269083176}, "45": {"success_count": 1655202, "total_count": 1790792, "success_rate": 92.42848974085209}}, "unique_stocks": 70, "unique_support_dates": 6217}, "1_year": {"total_trades": 9063705, "successful_trades": 8682403, "failed_trades": 272266, "success_rate": 95.79308902926562, "by_wait_days": {"0": {"success_count": 1598484, "total_count": 1709555, "success_rate": 93.50292912483073}, "30": {"success_count": 1519944, "total_count": 1577230, "success_rate": 96.36793619193142}, "60": {"success_count": 1461904, "total_count": 1513930, "success_rate": 96.56351350458739}, "90": {"success_count": 1415856, "total_count": 1466110, "success_rate": 96.57228993731711}, "120": {"success_count": 1375889, "total_count": 1428080, "success_rate": 96.34537280824603}, "180": {"success_count": 1310326, "total_count": 1368800, "success_rate": 95.72808299240211}}, "by_expiry_days": {"7": {"success_count": 1768467, "total_count": 1812741, "success_rate": 97.55762130387076}, "14": {"success_count": 1753076, "total_count": 1812741, "success_rate": 96.70857557698534}, "21": {"success_count": 1739239, "total_count": 1812741, "success_rate": 95.9452563824617}, "30": {"success_count": 1722906, "total_count": 1812741, "success_rate": 95.04424515140332}, "45": {"success_count": 1698715, "total_count": 1812741, "success_rate": 93.709746731607}}, "unique_stocks": 70, "unique_support_dates": 6122}}, "all_stocks": ["AAK AB", "ABB Ltd", "ASSA ABLOY AB ser. B", "Alfa Laval AB", "AstraZeneca PLC", "Atlas Copco AB ser. A", "Autoliv Inc. SDB", "Avanza Bank Holding AB", "Axfood AB", "Betsson AB ser. B", "Billerud Aktiebolag", "Boliden AB", "Castellum AB", "Dometic Group AB", "EQT AB", "Electrolux, AB ser. B", "Elekta AB ser. B", "Embracer Group AB ser. B", "Epiroc AB ser. A", "Ericsson, Telefonab. L M ser. B", "Essity AB ser. B", "Evolution AB", "Fabege AB", "Fastighets AB Balder ser. B", "Fingerprint Cards AB ser. B", "Fortnox AB", "Getinge AB ser. B", "HEXPOL AB ser. B", "Hennes & Mauritz AB, H & M ser. B", "Hexagon AB ser. B", "Holmen AB ser. B", "Husqvarna AB ser. B", "Industrivärd AB ser. C", "Intrum AB", "Investor AB ser. B", "JM AB", "Kindred Group plc", "Kinnevik AB ser. B", "Latour, Investmentab. ser. B", "Lundin Mining Corporation", "Millicom International Cellular S.A. SDB", "Modern Times Group MTG AB ser. B", "NCC AB ser. B", "NIBE Industrier AB ser. B", "New Wave Group AB ser. B", "Nordea Bank Abp", "OMXS30", "Orr\u00f6n Energy AB", "Ratos AB ser. B", "SAAB AB ser. B", "SKF, AB ser. B", "SSAB AB ser. A", "Sagax AB B", "Samhällsbyggnadsbolaget i Norden AB ser. B", "Sandvik AB", "Securitas AB ser. B", "Sinch AB", "Skandinaviska Enskilda Banken ser. A", "Skanska AB ser. B", "Stora Enso Oyj ser. R", "Svenska Cellulosa AB SCA ser. B", "Svenska Handelsbanken ser. A", "Swedbank AB ser A", "Swedish Orphan Biovitrum AB", "TRATON SE", "Tele2 AB ser. B", "Telia Company AB", "Trelleborg AB ser. B", "Volvo Car AB ser. B", "Volvo, AB ser. B"], "wait_time_constraints": {"1-Month": [0, 30], "3-Month": [0, 30, 60, 90], "6-Month": [0, 30, 60, 90, 120, 180], "9-Month": [0, 30, 60, 90, 120, 180], "1-Year": [0, 30, 60, 90, 120, 180]}, "expiry_periods": [7, 14, 21, 30, 45]};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            loadDashboardData();
            initializeCharts();
            setupEventListeners();
        });

        function loadDashboardData() {
            try {
                dashboardData = embeddedDashboardData;

                // Populate stocks dropdown
                const stockSelect = document.getElementById('stockSelect');
                dashboardData.all_stocks.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock;
                    option.textContent = stock;
                    stockSelect.appendChild(option);
                });

                // Initialize stats
                displayKeyStatistics();
                displayPeriodStatistics();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('statsGrid').innerHTML =
                    '<div class="error-message">Error loading dashboard data. Please refresh the page.</div>';
            }
        }

        function displayKeyStatistics() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            if (!dashboardData || !dashboardData.statistics) return;

            const stats = dashboardData.statistics;

            // Calculate overall stats
            let totalTrades = 0, totalSuccess = 0;
            Object.values(stats).forEach(s => {
                totalTrades += s.total_trades;
                totalSuccess += s.successful_trades;
            });

            const overallSuccessRate = totalTrades > 0 ? (totalSuccess / totalTrades * 100).toFixed(1) : 0;

            const statCards = [
                { label: 'Total Trades Analyzed', value: totalTrades.toLocaleString(), subvalue: 'across all periods' },
                { label: 'Overall Success Rate', value: `${overallSuccessRate}%`, subvalue: 'supported trades held above level' },
                { label: 'Unique Stock-Support Events', value: Object.values(stats).reduce((sum, s) => sum + s.unique_support_dates, 0).toLocaleString(), subvalue: 'historical support levels' },
                { label: 'Periods Analyzed', value: Object.keys(stats).length, subvalue: '1M, 3M, 6M, 9M, 1Y' }
            ];

            statCards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.innerHTML = `
                    <h3>${card.label}</h3>
                    <div class="value">${card.value}</div>
                    <div class="subvalue">${card.subvalue}</div>
                `;
                statsGrid.appendChild(div);
            });
        }

        function displayPeriodStatistics() {
            const tbody = document.getElementById('periodStatsBody');
            tbody.innerHTML = '';

            if (!dashboardData || !dashboardData.statistics) return;

            const stats = dashboardData.statistics;

            Object.entries(stats).forEach(([period, data]) => {
                const successRate = data.success_rate.toFixed(1);
                let rateClass = 'success-low';
                if (successRate >= 90) rateClass = 'success-high';
                else if (successRate >= 85) rateClass = 'success-medium';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${period.replace('_', ' ')}</strong></td>
                    <td>${data.total_trades.toLocaleString()}</td>
                    <td style="color: #28a745;">${data.successful_trades.toLocaleString()}</td>
                    <td style="color: #dc3545;">${data.failed_trades.toLocaleString()}</td>
                    <td class="${rateClass}">${successRate}%</td>
                    <td>${data.unique_stocks}</td>
                    <td>${data.unique_support_dates.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function setupEventListeners() {
            document.getElementById('periodSelect').addEventListener('change', updateWaitTimes);
            document.getElementById('stockSelect').addEventListener('change', updateCharts);
            document.getElementById('waitSelect').addEventListener('change', updateCharts);
            document.getElementById('expirySelect').addEventListener('change', updateCharts);

            // Initial population
            updateWaitTimes();
        }

        function updateWaitTimes() {
            const periodSelect = document.getElementById('periodSelect');
            const waitSelect = document.getElementById('waitSelect');
            const period = periodSelect.value;

            waitSelect.innerHTML = '<option value="">-- Select Wait Days --</option>';

            if (!period) {
                document.getElementById('waitInfo').textContent = '';
                return;
            }

            const validWaitTimes = WAIT_TIME_CONSTRAINTS[period] || [];

            validWaitTimes.forEach(days => {
                const option = document.createElement('option');
                option.value = days;
                option.textContent = `${days} days`;
                waitSelect.appendChild(option);
            });

            document.getElementById('waitInfo').textContent =
                `Valid wait times for ${period}: ${validWaitTimes.join(', ')} days`;
        }

        async function updateCharts() {
            const stock = document.getElementById('stockSelect').value;
            const period = document.getElementById('periodSelect').value;
            const waitDays = document.getElementById('waitSelect').value;
            const expiryDays = document.getElementById('expirySelect').value;

            if (!stock || !period || !waitDays || !expiryDays) {
                document.getElementById('chartMessage').style.display = 'block';
                document.getElementById('chartWrapper').style.display = 'none';
                document.getElementById('chartStats').style.display = 'none';
                document.getElementById('chartMessage').textContent = 'Select all filters to view the price chart';
                return;
            }

            await loadPriceChart(stock, period, parseInt(waitDays), parseInt(expiryDays));
        }

        async function loadPriceChart(stock, period, waitDays, expiryDays) {
            const chartMessage = document.getElementById('chartMessage');
            const chartWrapper = document.getElementById('chartWrapper');
            const chartStats = document.getElementById('chartStats');

            try {
                chartMessage.textContent = 'Loading chart data...';
                chartMessage.style.display = 'block';
                chartWrapper.style.display = 'none';
                chartStats.style.display = 'none';

                // Build key for chart data
                const periodKey = period.replace(/ /g, '_').replace(/-/g, '');
                const dataKey = `${stock}_${periodKey}_${waitDays}_${expiryDays}`;

                // Check if we have pregenerated data
                if (window.chartDataSamples && window.chartDataSamples[dataKey]) {
                    displayChart(window.chartDataSamples[dataKey]);
                    chartMessage.style.display = 'none';
                } else {
                    // Data not available - show instructions
                    const cmd = `python3 generate_chart_data.py "${stock}" "${period}" ${waitDays} ${expiryDays}`;
                    chartMessage.innerHTML = `
                        <div style="background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #0099cc;">
                            <p style="margin: 0 0 15px 0; font-weight: bold; color: #333;">💡 Chart data not pre-generated for this combination</p>
                            <p style="margin: 0 0 10px 0; color: #555;">To generate price chart for <strong>${stock}</strong>, run in terminal:</p>
                            <code style="background: #f5f5f5; padding: 10px; display: block; margin: 10px 0; border-radius: 4px; overflow-x: auto; color: #0066cc; font-family: monospace;">${cmd}</code>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">The chart data has 60 days before support through 30 days after option expiry.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error:', error);
                chartMessage.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                chartMessage.style.display = 'block';
            }
        }

        function displayChart(data) {
            const chartWrapper = document.getElementById('chartWrapper');
            const chartMessage = document.getElementById('chartMessage');
            const chartStats = document.getElementById('chartStats');

            if (!data.examples || data.examples.length === 0) {
                chartMessage.innerHTML = '<div class="error-message">No chart data available</div>';
                return;
            }

            // Use first example
            const example = data.examples[0];
            const priceHistory = example.price_history;

            if (!priceHistory || priceHistory.length === 0) {
                chartMessage.innerHTML = '<div class="error-message">No price history available</div>';
                return;
            }

            // Prepare data for Chart.js
            const dates = priceHistory.map(p => p.date);
            const closes = priceHistory.map(p => p.close);
            const highs = priceHistory.map(p => p.high || p.close);
            const lows = priceHistory.map(p => p.low || p.close);

            const supportDate = new Date(example.support_date);
            const testDate = new Date(example.test_date);
            const expiryDate = new Date(example.expiry_date);

            // Create chart
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (window.priceChartInstance) {
                window.priceChartInstance.destroy();
            }

            window.priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Close Price (kr)',
                            data: closes,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.05)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointBackgroundColor: '#667eea',
                            pointHoverRadius: 6
                        },
                        {
                            label: 'High Price (kr)',
                            data: highs,
                            borderColor: 'rgba(102, 126, 234, 0.4)',
                            borderWidth: 1,
                            fill: false,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Low Price (kr)',
                            data: lows,
                            borderColor: 'rgba(220, 53, 69, 0.4)',
                            borderWidth: 1,
                            fill: false,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: `Support Level: ${example.support_level.toFixed(2)} kr`,
                            data: Array(dates.length).fill(example.support_level),
                            borderColor: '#28a745',
                            borderWidth: 2,
                            fill: false,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        annotation: {
                            annotations: {
                                box1: {
                                    type: 'box',
                                    xMin: example.support_date,
                                    xMax: example.test_date,
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Price (kr)' },
                            grid: { drawBorder: false }
                        },
                        x: {
                            title: { display: true, text: 'Date' },
                            grid: { drawBorder: false }
                        }
                    }
                }
            });

            // Update stats
            document.getElementById('totalTrades').textContent = data.total_records.toLocaleString();
            document.getElementById('successCount').textContent = data.summary.success_count.toLocaleString();
            document.getElementById('failureCount').textContent = data.summary.failure_count.toLocaleString();
            const rateColor = data.summary.success_rate >= 90 ? 'success-high' :
                            data.summary.success_rate >= 85 ? 'success-medium' : 'success-low';
            document.getElementById('successRate').className = rateColor;
            document.getElementById('successRate').textContent = `${data.summary.success_rate.toFixed(1)}%`;

            // Show elements
            chartMessage.style.display = 'none';
            chartWrapper.style.display = 'block';
            chartStats.style.display = 'block';
        }

        function initializeCharts() {
            if (!dashboardData || !dashboardData.statistics) return;

            const stats = dashboardData.statistics;

            // Period Success Rates Chart
            const periodLabels = Object.keys(stats).map(p => p.replace('_', ' '));
            const successRates = Object.values(stats).map(s => s.success_rate);

            const successCtx = document.getElementById('periodSuccessChart').getContext('2d');
            new Chart(successCtx, {
                type: 'bar',
                data: {
                    labels: periodLabels,
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: successRates,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            '#28a745', '#28a745', '#ffc107', '#ffc107', '#dc3545'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Period Trade Volume Chart
            const volumeCtx = document.getElementById('periodVolumeChart').getContext('2d');
            new Chart(volumeCtx, {
                type: 'doughnut',
                data: {
                    labels: periodLabels,
                    datasets: [{
                        data: Object.values(stats).map(s => s.total_trades),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Wait Days Impact (combine all periods)
            let waitDaysStats = {};
            Object.values(stats).forEach(periodStats => {
                Object.entries(periodStats.by_wait_days).forEach(([days, data]) => {
                    if (!waitDaysStats[days]) {
                        waitDaysStats[days] = { total: 0, success: 0 };
                    }
                    waitDaysStats[days].success += data.success_count;
                    waitDaysStats[days].total += data.total_count;
                });
            });

            const waitDaysLabels = Object.keys(waitDaysStats).sort((a, b) => parseInt(a) - parseInt(b));
            const waitDaysSuccessRates = waitDaysLabels.map(days => {
                const d = waitDaysStats[days];
                return d.total > 0 ? (d.success / d.total * 100) : 0;
            });

            const waitCtx = document.getElementById('waitDaysChart').getContext('2d');
            new Chart(waitCtx, {
                type: 'line',
                data: {
                    labels: waitDaysLabels.map(d => `${d}d`),
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: waitDaysSuccessRates,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#667eea',
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Expiry Days Impact
            let expiryStats = {};
            Object.values(stats).forEach(periodStats => {
                Object.entries(periodStats.by_expiry_days).forEach(([days, data]) => {
                    if (!expiryStats[days]) {
                        expiryStats[days] = { total: 0, success: 0 };
                    }
                    expiryStats[days].success += data.success_count;
                    expiryStats[days].total += data.total_count;
                });
            });

            const expiryLabels = Object.keys(expiryStats).sort((a, b) => parseInt(a) - parseInt(b));
            const expirySuccessRates = expiryLabels.map(days => {
                const d = expiryStats[days];
                return d.total > 0 ? (d.success / d.total * 100) : 0;
            });

            const expiryCtx = document.getElementById('expiryDaysChart').getContext('2d');
            new Chart(expiryCtx, {
                type: 'line',
                data: {
                    labels: expiryLabels.map(d => `${d}d`),
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: expirySuccessRates,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#764ba2',
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }
    </script>
</body>
</html>
